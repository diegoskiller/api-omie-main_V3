


<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador do Setor de Cobre</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #525151;
        margin: 0;
        padding: 0;
    }
    h2 {
        text-align: center;
        margin-top: 20px;
        color: #fff;
    }
    .container {
        display: flex;
        justify-content: space-between;
        padding: 0px;
    }
    .containerModal {
        min-width: 250px;
    }
    .containerModal2 {
        min-width: 200px;
    }
    .column {
        width: 22%;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 8px 16px rgba(248, 247, 247, 0.411); /* Suavizado a sombra */
    }
    input {
        width: 130px;
        height: 12px;
        padding: 2px;
    }
    select {
        width: 138px;
        height: 20px;
        padding: 2px;
    }
    .column h3 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        color: #fff;
    }
    #pedidos-setor {
        background-color: #2196F3; /* Azul */
    }
    #producao-setor {
        background-color: #FF9800; /* Laranja */
    }
    #qualidade-setor {
        background-color: #E91E63; /* Rosa */
    }
    #expedicao-setor {
        background-color: #4CAF50; /* Verde */
    }
    .setor {
        min-height: 200px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
        background-color: rgba(145, 143, 143, 0.479); /* Sombra mais clara */
    }
    .card {
        background-color: #d3dff591;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 13px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .card:hover {
        background-color: #f2f2f2;
    }
    .status-estoque {
        color: green;
        font-weight: bold;
    }
    .readonly-input {
        background-color: #d1cfcf; /* Cinza claro */
        color: #666; /* Texto em cinza escuro */
        width: 80px;
        height: 10px;
    }
    .readonly-input2 {
        background-color: #d1cfcf; /* Cinza claro */
        color: #666; /* Texto em cinza escuro */
        width: 130px;
        height: 10px;
    }
    .read-input {
        background-color: #ffffff; /* Cinza claro */
        width: 80px;    
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        text-align: left;
        top: 0;
        width: 100%;
        height: 60%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
        background-color: #eeeded;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        border-radius: 8px;
        height: 75%; /* Ajuste a altura do modal de faturamento */
    }
    .modal-content2 {
        background-color: #eeeded;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        border-radius: 8px;
        height: 75%; /* Ajuste a altura do modal de faturamento */
    }
    .close {
        color: #f00505;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .detail-field {
        margin-bottom: 10px;
    }
    .detail-field label {
        color: rgb(2, 8, 66);
        font-weight: bold;
    }
    .navbar {
        background-color: #343a40;
        color: #fff;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .navbar-brand {
        font-size: 24px;
        font-weight: bold;
        text-decoration: none;
    }
    .navbar-nav {
        list-style-type: none;
        margin: 0;
        padding: 0;
        display: flex;
        gap: 10px; /* Espaçamento entre os botões */
    }
    .nav-item {
        margin-right: 10px;
    }
    .nav-link {
        display: inline-block;
        color: #fff;
        text-decoration: none;
        font-size: 18px;
        padding: 10px 20px;
        border-radius: 25px; /* Bordas arredondadas */
        background-color: #007bff; /* Cor do fundo */
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    .nav-link:hover {
        background-color: #0056b3; /* Cor do fundo ao passar o mouse */
        color: #ffc107;
    }
    .usuario {
        font-size: 18px;
    }
    .modal-buttons button {
        padding: 8px 15px;
        border: none;
        border-radius: 25px;
        margin-right: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .modal-buttons button:hover {
        background-color: #ddd;
    }
    .modal-aligned {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light w-100 fixed-top header border-bottom border-2 border-dark">
    <img src="{{ url_for('static', filename='images/logo-iso.png')}}" width=200 alt="logo">
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link card-menu text-center" href="{{url_for('index')}}">Sistema kels</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{url_for('pedidos')}}">Pedidos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{url_for('pedidos_faturados')}}">Faturados</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{url_for('ferramentas')}}">Ferramentas</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{url_for('estoque_cobre')}}">Estoque</a>
        </li>
    </ul>
    <div class="usuario">
        <p>Bem vindo: {{ current_user.name }} | <a href="/logout" class="text-warning">Sair</a></p>
    </div>
</nav>

<h2>Gerenciador do Setor de Cobre</h2>
<div class="container">
    <div class="column">
        <h3>Pedidos</h3>

        <div class="setor" id="pedidos-setor">
            <b> Pedido | Cliente | Peso &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
                <button class="save-ccl" style="background-color: #ffffff; border-radius: 15px;">
                    <img src="{{ url_for('static', filename='images/repeat.svg')}}" alt="Atualizando">
                </button>
                <br>
                Código | Data Ent | Estoque<br></b><hr/> 
            {% for pedido in pedidos %}
            {% if pedido.Status == 'Emitido' %}

            <div class="card" data-pedido-id="{{ pedido.id }}" data-estoque="{{ pedido.estoque }}" data-quantidade="{{ pedido.quantidade }}" ondblclick="showDetails('{{ pedido.data_entrega }}', '{{ pedido.dimensional }}',
            '{{ pedido.descricao }}', '{{ pedido.cliente }}', '{{ pedido.quantidade }}', '{{ pedido.codigo }}',
            '{{ pedido.pedido }}', '{{ pedido.Status }}', '{{ pedido.obs_entrega }}', '{{ pedido.peso }}', '{{ pedido.peso_total }}', '{{ pedido.material }}',
             '{{ pedido.peso_material }}', '{{ pedido.amarrados }}', '{{ pedido.dimencional_real }}',
             '{{ pedido.obs }}', '{{ pedido.estoque }}')" draggable="true">
            Desc.:{{ pedido.descricao }}<br>
            <hr/> 
            {{ pedido.pedido }} | {{ pedido.cliente }} | {{ pedido.quantidade }}kg<br>
            {{ pedido.codigo }} | {{ pedido.data_entrega }} | {{ pedido.estoque}}kg<br>
            <hr/>  
            Med.:{{ pedido.dimensional }} | {{pedido.canto}}
            <hr/>
            {% if pedido.estoque >= pedido.quantidade %} 
                <span class="status-estoque">Status: Pedido em Estoque</span> 
            {% else %} 
            <p style="color: red; background-color: #ccc;">
                <span>Status: Precisa Produzir {{pedido.quantidade - pedido.estoque}}kg</span></p>
                
            {% endif %}
        </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="column">
        <h3>Produção</h3>
        <div class="setor" id="producao-setor">
            <b> Pedido | Cliente | Peso &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
                <button class="save-ccl" style="background-color: #ffffff; border-radius: 15px;">
                    <img src="{{ url_for('static', filename='images/repeat.svg')}}" alt="Atualizando">
                </button>
                <br>
                Código | Data Ent | Estoque<br></b><hr/> 
            {% for pedido in pedidos %}
            {% if pedido.Status == 'Produzindo' %}

            <div class="card" data-pedido-id="{{ pedido.id }}" data-estoque="{{ pedido.estoque }}" data-quantidade="{{ pedido.quantidade }}" ondblclick="showDetails('{{ pedido.data_entrega }}', '{{ pedido.dimensional }}',
           '{{ pedido.descricao }}', '{{ pedido.cliente }}', '{{ pedido.quantidade }}', '{{ pedido.codigo }}',
            '{{ pedido.pedido }}', '{{ pedido.Status }}','{{ pedido.obs_entrega }}', '{{ pedido.peso }}', '{{ pedido.peso_total }}', '{{ pedido.material }}',
             '{{ pedido.peso_material }}', '{{ pedido.amarrados }}', '{{ pedido.dimencional_real }}',
             '{{ pedido.obs }}', '{{ pedido.estoque }}')" draggable="true">
            Desc.: {{ pedido.descricao }}<br>
            <hr/> 
            {{ pedido.pedido }} | {{ pedido.cliente }} | {{ pedido.quantidade }}kg<br>
            {{ pedido.codigo }} | {{ pedido.data_entrega }} | {{ pedido.estoque}}kg<br>
            <hr/> 
            Med.:{{ pedido.dimensional }} | {{pedido.canto}}
            <hr/>
            {% if pedido.estoque >= pedido.quantidade %} 
                <span class="status-estoque">Status: já em Estoque, A quantidade precisa ser ajustada no almoxarifado</span> 
            {% else %} 
                <span>Status: Produzindo</span> 
            {% endif %}
            <hr/>
            <div class="container">
                <div style="text-align: left; line-height: 20px;"><b>
                    <label class="edit-input" style="display:none;">Qtd. Produzida:<br></label>
                    <label class="edit-input" style="display:none;">Peso com Emb:<br></label>
                    <label class="edit-input" style="display:none;">Matéria Prima :<br></label>
                    <label class="edit-input" style="display:none;">Peso Mat. Pri. :<br></label>
                    <label class="edit-input" style="display:none;">Qtd.Amarrados:<br></label>
                    <label class="edit-input" style="display:none;">Dimensional   :<br></label>
                    <label class="edit-input" style="display:none;">Observaçóes  :<br></label>
                </b>
                </div>
                <div>
                    <input type="number" class="edit-input {% if pedido.peso %}readonly-input2{% endif %}" name="peso" data-field="peso" value="{{ pedido.peso|default('', true) }}" autocomplete="off" style="display:none;" {% if pedido.peso %}readonly{% endif %}>
                    <input type="number" class="edit-input" name="peso_total" data-field="peso_total" value="{{ pedido.peso_total|default('', true) }}" autocomplete="off" style="display:none;">
                    <select class="edit-input" name="material" data-field="material" autocomplete="off" style="display:none;">
                    <option value="01CUVERG6" {% if pedido.material == '01CUVERG6' %}selected{% endif %}>01CUVERG6</option>
                    <option value="01CUVERG7" {% if pedido.material == '01CUVERG7' %}selected{% endif %}>01CUVERG7</option>
                    </select>
                    <input type="number" class="edit-input {% if pedido.peso_material %}readonly-input2{% endif %}" name="peso_material" data-field="peso_material" value="{{ pedido.peso_material|default('', true) }}" autocomplete="off" style="display:none;" {% if pedido.peso_material %}readonly{% endif %}>
                    <input type="text" class="edit-input" name="amarrados" data-field="amarrados" value="{{ pedido.amarrados|default('', true) }}" autocomplete="off" style="display:none;">
                    <input type="text" class="edit-input" name="dimencional_real" data-field="dimencional_real" value="{{ pedido.dimencional_real|default('', true) }}" autocomplete="off" style="display:none;">
                    <input type="text" class="edit-input" name="obs" data-field="obs" value="{{ pedido.obs|default('', true) }}" autocomplete="off" style="display:none;">
                </div>
            </div>
            
            <!-- Adicione outros campos da mesma forma --><b>
                <div class="modal-buttons">
            
                <button class="edit-btn" style="background-color: #f78254; border-radius: 5px;">Produzir ou Editar Produção ></button>
                <p>
                <button class="save-btn" style="display:none; background-color: #4059e6; border-radius: 5px;"> Produzir / Salvar</button>
                <button class="save-ccl" style="display:none; background-color: #f84444; border-radius: 5px;"> Cancelar </button>
                </div>
            </b>
            </div>
            {% endif %}

            {% endfor %}
    </div>
    </div>
    <div class="column">
        <h3>Qualidade</h3>
        <div class="setor" id="qualidade-setor"> 
            <b> Pedido | Cliente | Peso &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
                <button class="save-ccl" style="background-color: #ffffff; border-radius: 15px;">
                    <img src="{{ url_for('static', filename='images/repeat.svg')}}" alt="Atualizando">
                </button>
                <br>
                Código | Data Ent | Estoque<br></b><hr/> 
            {% for pedido in pedidos %}
            {% if pedido.Status == 'Qualidade' %}
            <div class="card" data-pedido-id="{{ pedido.id }}" data-estoque="{{ pedido.estoque }}" data-quantidade="{{ pedido.quantidade }}" ondblclick="showDetails('{{ pedido.data_entrega }}', '{{ pedido.dimensional }}',
            '{{ pedido.descricao }}', '{{ pedido.cliente }}', '{{ pedido.quantidade }}', '{{ pedido.codigo }}',
            '{{ pedido.pedido }}', '{{ pedido.Status }}','{{ pedido.obs_entrega }}', '{{ pedido.peso }}', '{{ pedido.peso_total }}', '{{ pedido.material }}',
             '{{ pedido.peso_material }}', '{{ pedido.amarrados }}', '{{ pedido.dimencional_real }}',
             '{{ pedido.obs }}', '{{ pedido.estoque }}')" draggable="true">
            Desc.:{{ pedido.descricao }}<br>
            <hr/> 
            {{ pedido.pedido }} | {{ pedido.cliente }} | {{ pedido.quantidade }}kg<br>
            {{ pedido.codigo }} | {{ pedido.data_entrega }} | {{ pedido.estoque}}kg<br>
            <hr/>  
            Med.:{{ pedido.dimensional }} | {{pedido.canto}}
            <hr/>
            {% if pedido.estoque >= pedido.quantidade %} 
                <span class="status-estoque">Status: Emitindo Certificado</span> 
            {% else %} 
            <p style="color: red; background-color: #ccc;">
                <span>Status: Sem Estoque Suficiente</span></p>
            {% endif %}

        </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="column">
        <h3>Expedição</h3>
        <div class="setor" id="expedicao-setor">
            <b> Pedido | Cliente | Peso &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
                <button class="save-ccl" style="background-color: #ffffff; border-radius: 15px;">
                    <img src="{{ url_for('static', filename='images/repeat.svg')}}" alt="Atualizando">
                </button>
                <br>
                Código | Data Ent | Estoque<br></b><hr/> 
            {% for pedido in pedidos %}
            {% if pedido.Status == 'Expedindo' %}
            <div class="card" data-pedido-id="{{ pedido.id }}" data-estoque="{{ pedido.estoque }}" data-quantidade="{{ pedido.quantidade }}" ondblclick="showDetails('{{ pedido.data_entrega }}', '{{ pedido.dimensional }}',
           '{{ pedido.descricao }}', '{{ pedido.cliente }}', '{{ pedido.quantidade }}', '{{ pedido.codigo }}',
            '{{ pedido.pedido }}', '{{ pedido.Status }}','{{ pedido.obs_entrega }}', '{{ pedido.peso }}', '{{ pedido.peso_total }}', '{{ pedido.material }}',
             '{{ pedido.peso_material }}', '{{ pedido.amarrados }}', '{{ pedido.dimencional_real }}',
             '{{ pedido.obs }}', '{{ pedido.estoque }}')" draggable="true">
            Desc.:{{ pedido.descricao }}<br>
            <hr/> 
            {{ pedido.pedido }} | {{ pedido.cliente }} | {{ pedido.quantidade }}kg<br>
            {{ pedido.codigo }} | {{ pedido.data_entrega }} | {{ pedido.estoque}}kg<br>
            <hr/> 
            Med.:{{ pedido.dimensional }} | {{pedido.canto}}
            <hr/>
            {% if pedido.estoque >= pedido.quantidade %} 
                <span class="status-estoque">Status: Disponível Para Faturar</span> 
            {% else %} 
            <p style="color: red; background-color: #ccc;">
                <span>Status: Sem Estoque Suficiente</span></p>
            {% endif %}
            <div class="modal-buttons">
            <button class="expe-btn" data-pedido-id="{{ pedido.id }}" data-pedido-numero="{{ pedido.pedido }}" data-pedido-estoque="{{ pedido.estoque }}" data-pedido-quantidade="{{ pedido.quantidade }}" style="background-color: #46b342; border-radius: 5px;">Faturar X</button>
            </div>    
        </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal de detalhes do pedido -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <div class="container">
        <div class="containerModal">
        <div class="detail-field">
            <label>Data de Entrega:</label>
            <span id="detail-data"></span>
        </div>
        <div class="detail-field">
            <label>Medida:</label>
            <span id="detail-medida"></span>
        </div>
        <div class="detail-field">
            <label>Descrição:</label>
            <span id="detail-descricao"></span>
        </div>
        <div class="detail-field">
            <label>Cliente:</label>
            <span id="detail-cliente"></span>
        </div>
        <div class="detail-field">
            <label>Quantidade do Pedido:</label>
            <span id="detail-quantidade"></span>
        </div>
        <div class="detail-field">
            <label>Código:</label>
            <span id="detail-codigo"></span>
        </div>
        <div class="detail-field">
            <label>Pedido:</label>
            <span id="detail-pedido"></span>
        </div>
        <div class="detail-field">
            <label>Status:</label>
            <span id="detail-acao"></span>
        </div>
        <div class="detail-field">
            <label>Obs.Entrega:</label>
            <span id="detail-obs_entrega"></span>
        </div>
    </div>

    <div class="containerModal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="detail-field">
            <label>Peso/Qtd Produzido:</label>
            <span id="detail-peso"></span>
        </div>
        <div class="detail-field">
            <label>Peso Produzido total:</label>
            <span id="detail-peso_total"></span>
            <label>C/Emb. </label>
        </div>
        <div class="detail-field">
            <label>Material Prima:</label>
            <span id="detail-material"></span>
        </div>
        <div class="detail-field">
            <label>Peso Material Usado:</label>
            <span id="detail-peso_material"></span>
        </div>
        
        <div class="detail-field">
            <label>Qtd. de Amarrados:</label>
            <span id="detail-amarrados"></span>
        </div>
        <div class="detail-field">
            <label>Dimensional Encontrado:</label>
            <span id="detail-dimencional_real"></span>
        </div>
        <div class="detail-field">
            <label>Observações de Produção:</label>
            <span id="detail-obs"></span>
        </div>
    </div>
</div>
</div>

<!-- Modal para faturamento -->
<div id="faturarModal" class="modal">
    <div class="modal-content2">
        <span class="close" onclick="closeFaturarModal()">&times;</span>
        <h2><p style="color: rgb(0, 0, 0); background-color: #cccccc00;">Dados para processar o Faturamento do Pedido</p></h2>
        <form id="faturarForm">
            <input type="hidden" id="faturar-pedido-id" name="pedido_id">
            <div class="modal-aligned">
                    <div class="detail-field">
                        <label for="faturado-omie">O item foi faturado pelo sistema Omie?</label>
                        <input type="checkbox" id="faturado-omie" name="faturado_omie"><span id="omie-status">Não</span>
                    </div>
                    
                    <div class="detail-field">    
                        
                    </div>
                <div class="containerModal2">
                    
                    <div class="detail-field">
                        <label for="peso-pedido">Peso do Pedido :</label>
                    </div>
                    <div class="detail-field">
                        <label for="peso-fabricado">Peso Fabricado :</label>
                    </div>
                    <div class="detail-field">
                        <label for="estoque-atual">Estoque Atual :</label>
                    </div>
                    <div class="detail-field">
                        <label for="faturar-peso">Peso Faturado :</label>
                    </div>
                    <div class="detail-field">
                        <label for="saldo">Saldo Futuro :</label>
                    </div>
                </div>
                <div>
                    <div class="detail-field">
                        <input type="number" step="0.01" id="peso-pedido" name="peso_pedido" readonly class="readonly-input">
                    </div>
                    <div class="detail-field">
                        <input type="number" step="0.01" id="peso-fabricado" name="peso_fabricado" readonly class="readonly-input">
                    </div>
                    <div class="detail-field">
                        <input type="number" step="0.01" id="estoque-atual" name="estoque_atual" readonly class="readonly-input">
                    </div>
                    <div class="detail-field">
                        <input type="number" step="0.01" id="faturar-peso" name="peso_faturado" required class="read-input">
                    </div>
                    <div class="detail-field">
                        <input type="number" step="0.01" id="saldo" name="saldo" readonly class="readonly-input">
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="submit" style="background-color: #59b0eb;">Processar o Faturamento</button>
                <button type="button" style="background-color: #f84444;" onclick="closeFaturarModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript libraries -->
<script src="//code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
   function showDetails(data, medida, descricao, cliente, quantidade, codigo, pedido, Status, obs_entrega, peso, peso_total,
                 material, peso_material, amarrados, dimencional_real, obs, estoque) {
        toggleFieldVisibility("detail-data", data);
        toggleFieldVisibility("detail-medida", medida);
        toggleFieldVisibility("detail-descricao", descricao);
        toggleFieldVisibility("detail-cliente", cliente);
        toggleFieldVisibility("detail-quantidade", quantidade);
        toggleFieldVisibility("detail-codigo", codigo);
        toggleFieldVisibility("detail-pedido", pedido);
        toggleFieldVisibility("detail-acao", Status);
        toggleFieldVisibility("detail-obs_entrega", obs_entrega);
        toggleFieldVisibility("detail-peso", peso);
        toggleFieldVisibility("detail-peso_total", peso_total);
        toggleFieldVisibility("detail-material", material);
        toggleFieldVisibility("detail-peso_material", peso_material);
        toggleFieldVisibility("detail-amarrados", amarrados);
        toggleFieldVisibility("detail-dimencional_real", dimencional_real);
        toggleFieldVisibility("detail-obs", obs);

        document.getElementById("myModal").style.display = "block";
    }

    function toggleFieldVisibility(fieldId, value) {
        var field = document.getElementById(fieldId).parentElement;
        if (value && value !== "None") {
            document.getElementById(fieldId).innerText = value;
            field.style.display = "block";
        } else {
            field.style.display = "none";
        }
    }

    function closeModal() {
        document.getElementById("myModal").style.display = "none";
    }

    function closeFaturarModal() {
        document.getElementById("faturarModal").style.display = "none";
    }

    function userHasPermission(action) {
        const user = "{{ current_user.name }}";
        const permissions = {
            "Valdemir": ["move_to_pedidos", "move_to_production", "produce"],
            "Joseane": ["move_to_expedition"],
            "Rodrigo Moreira": ["move_to_quality", "invoice"],
            "Diego": ["move_to_pedidos", "move_to_production", "produce", "move_to_expedition", "move_to_quality", "invoice"]
        };

        if (permissions[user] && permissions[user].includes(action)) {
            return true;
        }

        return false;
    }

    $(function() {
        $(".card").draggable({
            revert: "invalid",
            zIndex: 100,
            start: function(event, ui) {
                $(this).data("startPosition", ui.helper.position());
            }
        });

        $(".setor").droppable({
            accept: ".card",
            drop: function(event, ui) {
                var startPosition = $(ui.draggable).data("startPosition");
                var endPosition = ui.helper.position();
                var deltaX = endPosition.left - startPosition.left;
                var deltaY = endPosition.top - startPosition.top;

                ui.helper.animate({
                    left: '+=' + deltaX,
                    top: '+=' + deltaY
                }, "slow");

                $(ui.draggable).appendTo(this).removeAttr("style");

                // Atualizar o status do pedido com base no setor onde o card foi solto
                var novoStatus;
                var action;

                if ($(this).attr('id') === 'pedidos-setor') {
                    novoStatus = 'Emitido';
                    action = "move_to_pedidos";
                } else if ($(this).attr('id') === 'producao-setor') {
                    novoStatus = 'Produzindo';
                    action = "move_to_production";
                } else if ($(this).attr('id') === 'qualidade-setor') {
                    novoStatus = 'Qualidade';
                    action = "move_to_quality";

                    // Verifica se o estoque é suficiente antes de permitir mover para Qualidade
                    var card = $(ui.draggable);
                    var estoque = parseFloat(card.attr('data-estoque'));
                    var quantidade = parseFloat(card.attr('data-quantidade'));

                    if (estoque < quantidade) {
                        alert("Não é possível mover para Qualidade, estoque insuficiente.");
                        location.reload();
                        return;
                    }
                } else if ($(this).attr('id') === 'expedicao-setor') {
                    novoStatus = 'Expedindo';
                    action = "move_to_expedition";
                }

                if (action === "move_to_quality" && (estoque >= quantidade)) {
                    // Permitir qualquer usuário mover para Qualidade se o estoque for suficiente
                } else if (!userHasPermission(action)) {
                    alert("Você não tem acesso para isso");
                    location.reload();
                    return;
                }

                // Obter o ID do pedido
                var pedidoId = $(ui.draggable).data('pedidoId');
                if (confirm("Tem certeza de que deseja mover o pedido?")) {
                    // Lógica para atualizar o status do pedido
                    atualizarStatusPedido(pedidoId, novoStatus);
                } else {
                    // Cancelado pelo usuário
                    location.reload();
                }
            }
        });

        function atualizarStatusPedido(pedidoId, novoStatus) {
            $.ajax({
                type: "POST",
                url: "/atualizar_status_pedido", // Endpoint do servidor para atualizar status
                data: JSON.stringify({ pedidoId: pedidoId, novoStatus: novoStatus }),
                contentType: "application/json",
                success: function(response) {
                    console.log("Status atualizado com sucesso.", response);
                },
                error: function(error) {
                    console.error("Erro ao atualizar o status do pedido:", error);
                }
            });
        }

    });

    $(document).ready(function() {
        $('.edit-btn').click(function() {
            if (!userHasPermission("produce")) {
                alert("Você não tem acesso para isso");
                return;
            }

            var card = $(this).closest('.card');
            card.find('.editable').hide();
            card.find('.edit-input').show();
            $(this).hide();
            card.find('.save-btn').show();
            card.find('.save-ccl').show();
        });

        $('.save-ccl').click(function() {
            location.reload()
        });

        $('.save-btn').click(function() {
            var card = $(this).closest('.card');
            var pedidoId = card.data('pedido-id');
            var updatedData = {};

            card.find('.edit-input').each(function() {
                var field = $(this).attr('name');
                var value = $(this).val();

                if (field === 'peso' || field === 'peso_total' || field === 'peso_material') {
                    updatedData[field] = parseFloat(value);  // Convertendo para float
                } else {
                    updatedData[field] = value;
                }
            });

            $.ajax({
                url: '/update_pedido',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify({ pedidoId: pedidoId, data: updatedData }),
                success: function(response) {
                    console.log("Resposta do servidor:", response);
                    alert('Dados atualizados com sucesso!');

                    // Esconde os inputs e mostra os valores atualizados
                    card.find('.edit-input').each(function() {
                        $(this).hide();
                        var field = $(this).attr('name');
                        card.find('.editable[data-field="' + field + '"]').text($(this).val()).show();
                    });

                    // Oculta o botão salvar e mostra o botão editar novamente
                    card.find('.save-btn').hide();
                    card.find('.save-ccl').hide();
                    card.find('.edit-btn').show();

                    location.reload();
                },
                error: function(xhr) {
                    alert('Erro ao salvar as alterações: ' + xhr.responseText);
                }
            });
        });

        $('.expe-btn').click(function() {
            if (!userHasPermission("invoice")) {
                alert("Você não tem acesso para isso");
                return;
            }

            var pedidoId = $(this).data('pedido-id');
            var pedidoQuantidade = $(this).data('pedido-quantidade');
            var estoqueAtual = $(this).data('pedido-estoque'); // Pega o valor do estoque atual
            var pesoFaturado = pedidoQuantidade; // Seta o valor padrão de peso faturado como o peso do pedido

            $('#faturar-pedido-id').val(pedidoId);
            $('#faturar-peso').val(pesoFaturado); // Define o valor do peso faturado
            $('#peso-pedido').val(pedidoQuantidade); // Define o peso do pedido
            $('#peso-fabricado').val(estoqueAtual); // Define o peso fabricado
            $('#estoque-atual').val(estoqueAtual); // Define o estoque atual
            $('#saldo').val((estoqueAtual - pesoFaturado).toFixed(2)); // Define o saldo inicial
            $('#faturarModal').show();
        });

        $('#faturar-peso').on('input', function() {
            var pesoFaturado = parseFloat($(this).val());
            var estoque = parseFloat($('#estoque-atual').val());
            var saldo = estoque - pesoFaturado;
            $('#saldo').val(saldo.toFixed(2)); // Atualiza o saldo
            if (saldo < 0) {
                $('#saldo').css('color', 'red');
            } else {
                $('#saldo').css('color', 'black');
            }
        });

        $('#faturado-omie').change(function() {
            var omieStatus = $('#faturado-omie').is(':checked') ? 'Sim' : 'Não';
            $('#omie-status').text(omieStatus);
        });

        $('#faturarForm').submit(function(e) {
            e.preventDefault();

            var pedidoId = $('#faturar-pedido-id').val();
            var faturadoOmie = $('#faturado-omie').is(':checked');
            var pesoFaturado = parseFloat($('#faturar-peso').val());
            var saldo = parseFloat($('#saldo').val());

            if (saldo < 0) {
                alert("Sem saldo em estoque para faturar essa quantidade.");
                return;
            }

            $.ajax({
                url: '/faturar_pedido',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify({ pedidoId: pedidoId, faturado_omie: faturadoOmie, peso_faturado: pesoFaturado }),
                success: function(response) {
                    alert('Pedido faturado com sucesso!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Erro ao faturar o pedido: ' + xhr.responseText);
                }
            });
        });
    });
</script>

</body>
</html>
